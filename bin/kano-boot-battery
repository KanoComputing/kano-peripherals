#!/bin/bash
#
# kano-boot-battery
#
# Copyright (C) 2017 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU GPL v2
#
# Detect if battery is present and with a low charge. Power off the kit if that's the case.
# This script is run very early on startup, when the filesystems are still mounted read only.
# See the file systemd/system/kano-bootup-battery.service for details.
#

. gettext.sh

console_tty="/dev/tty1"
export TEXTDOMAIN="kano-peripherals"

function sysrq_power_off() {

    # As a safety measure, if root file system is not mounted Ready Only, abort.
    /bin/mount | /bin/grep "on / " | /bin/grep "ro"
    if [ "$?" == 0 ]; then
	# power off immediately via kernel sysrq
	echo 1 > /proc/sys/kernel/sysrq
	echo o > /proc/sysrq-trigger
    else
	echo "rootfs is not mounted ReadOnly, aborting"
    fi

    return;
}

#
# Script entry
#
/usr/bin/battery-status
if [ "$?" == "1" ]; then

    # Setupcon sets up the correct font size on the console
    /bin/setupcon

    # Stop the bootup animation, clear the terminal,
    kano-stop-splash boot
    echo -e '\033\0143' > $console_tty

    # Display message on the console then power off
    eval_gettext "WARNING: Battery charge is too low, please connect the charger" > $console_tty
    echo > $console_tty
    eval_gettext "Powering off the kit now..." > $console_tty
    echo > $console_tty

    sleep 10
    sysrq_power_off
fi

exit 0
